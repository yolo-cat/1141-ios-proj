# Supabase 開發步驟（階段一）

依據 `supabase/AGENTS.md` 與 `stage_1_prd.md` 進行，主要目標是建立 `readings` 資料表並設定 RLS。

## 步驟
1. **準備**  
   - 取得 Supabase `project ref` 與 `anon key`。  
   - 閱讀 `supabase/AGENTS.md` 確認 schema 與權限要求。

2. **建立資料表（可重複執行）**  
   在 Supabase SQL Editor 或 CLI 執行以下指令：
   ```sql
   create table if not exists public.readings (
     id int8 generated by default as identity primary key, -- 唯一識別碼
     created_at timestamptz not null default now(),        -- 上傳時間
     device_id text not null,                              -- 裝置/茶倉 ID
     temperature float4 not null,                          -- 攝氏溫度
     humidity float4 not null                              -- 相對濕度
   );
   ```

3. **啟用 RLS 並建立策略（可重複執行）**  
   ```sql
   alter table public.readings enable row level security;

   drop policy if exists "allow anon insert" on public.readings;
   create policy "allow anon insert" on public.readings
     for insert to anon
     with check (true);

   drop policy if exists "allow authenticated select" on public.readings;
   create policy "allow authenticated select" on public.readings
     for select to authenticated
     using (true);
   ```

4. **驗證 REST 入口**  
   以 `anon key` 測試 `POST https://<PROJECT_REF>.supabase.co/rest/v1/readings`：
   ```bash
   curl -X POST "https://<PROJECT_REF>.supabase.co/rest/v1/readings" \
     -H "apikey: $SUPABASE_ANON_KEY" \
     -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
     -H "Content-Type: application/json" \
     -H "Prefer: return=minimal" \
     -d '{"device_id":"tea_room_01","temperature":25.5,"humidity":62.0}'
   ```
   - 成功預期回應 `201 Created`（無內容）；常見錯誤：`401/403` 權限錯誤、`400` 欄位驗證錯誤。
   - 以 `authenticated` token 測試 SELECT 以確認 RLS：  
   ```bash
   curl "https://<PROJECT_REF>.supabase.co/rest/v1/readings?select=*" \
     -H "apikey: $SUPABASE_ANON_KEY" \
     -H "Authorization: Bearer $ACCESS_TOKEN"
   ```

5. **交付**  
   - 將使用的 SQL 指令或匯出的 migration 檔放入 `supabase/`。  
   - 確認文件內容與 PRD 一致的欄位型別（溫濕度皆為 `float4`）。
